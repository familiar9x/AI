server {
  listen 80;
  server_name rag.company.local;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  server_name rag.company.local;

  ssl_certificate     /etc/nginx/certs/fullchain.pem;
  ssl_certificate_key /etc/nginx/certs/privkey.pem;

  # oauth2-proxy endpoints
  location /oauth2/ {
    proxy_pass http://oauth2-proxy:4180;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Scheme $scheme;
  }

  # internal auth check
  location = /oauth2/auth {
    proxy_pass http://oauth2-proxy:4180/oauth2/auth;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Scheme $scheme;
    proxy_set_header Content-Length "";
    proxy_pass_request_body off;
  }

  # UI (OpenWebUI) – protected by SSO
  location / {
    auth_request /oauth2/auth;
    error_page 401 = /oauth2/start?rd=$scheme://$host$request_uri;

    proxy_pass http://openwebui:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # API – protected by SSO + pass Bearer token
  location /api/ {
    auth_request /oauth2/auth;
    error_page 401 = /oauth2/start?rd=$scheme://$host$request_uri;

    proxy_pass http://backend:8080/;  # note trailing slash
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;

    # get Authorization (Bearer) from oauth2-proxy auth subrequest
    auth_request_set $auth_header $upstream_http_authorization;
    proxy_set_header Authorization $auth_header;

    # optional identity headers
    auth_request_set $user  $upstream_http_x_auth_request_user;
    auth_request_set $email $upstream_http_x_auth_request_email;
    auth_request_set $groups $upstream_http_x_auth_request_groups;
    proxy_set_header X-User $user;
    proxy_set_header X-Email $email;
    proxy_set_header X-Groups $groups;
  }
}
